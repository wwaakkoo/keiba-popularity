# 払い戻しデータのみ更新機能 - 使い方ガイド

## 概要

過去に登録したレースデータに、後から馬券人気データを追加できる機能です。

## 使用シーン

- 過去に登録したレースデータに馬券人気がない
- Chrome拡張機能で12R一括取得した払い戻しデータを既存レースに追加したい
- レース結果データはそのまま、払い戻しデータだけ更新したい

## 使い方

### 1. 既存データの確認

1. アプリを開く
2. 「データ入力」タブで、更新したい競馬場と日付を選択
3. 既にデータが登録されていることを確認（保存済みデータ一覧に表示される）

### 2. 払い戻しデータの準備

Chrome拡張機能で取得した払い戻しデータ、または手動で入力したデータを用意：

```
1R
単勝
4
270
1人気
複勝
4
7
11
110
120
120
1人気
3人気
2人気
枠連
3
5
520
2人気
馬連
4 7
490
2人気
...

2R
単勝
7
110
1人気
...
```

### 3. 更新実行

1. 「データ入力」タブで競馬場と日付を選択
2. 「払い戻しデータ」欄に上記のテキストを貼り付け
3. 「🔄 払い戻しデータのみ更新」ボタンをクリック

### 4. 整合性チェック

システムが自動的に以下をチェックします：

- **単勝**: 1着馬番と一致するか
- **馬連**: 1-2着の組み合わせと一致するか
- **馬単**: 1→2着の順序と一致するか
- **3連複**: 1-2-3着の組み合わせと一致するか
- **3連単**: 1→2→3着の順序と一致するか

#### 矛盾が見つかった場合

確認ダイアログが表示されます：

```
⚠️ 以下のデータに矛盾が見つかりました:

・1R 新馬戦: 単勝不一致
  単勝馬番4が1着馬番3と一致しません
  期待値: 3, 実際: 4

それでも更新を続行しますか？
（レース結果と払い戻しデータが異なるレース開催の可能性があります）
```

- **続行**: データに矛盾があることを承知の上で更新
- **キャンセル**: 更新を中止し、データを確認

### 5. 更新完了

成功メッセージが表示されます：

```
✅ 払い戻しデータを更新しました

更新件数: 12レース

⚠️ 警告: 1件
2R 1勝クラス: 払い戻しデータが見つかりませんでした
```

## 安全機能

### 1. 既存データ保護

- レース名、条件、着順などは変更されません
- 払い戻しデータと馬券人気のみが上書きされます

### 2. 整合性チェック

- レース結果と払い戻しデータの矛盾を自動検出
- 矛盾がある場合は警告を表示し、確認を求めます

### 3. 元データ保持

- 更新前のデータはブラウザのLocalStorageに保存されています
- 必要に応じてエクスポート機能でバックアップ可能

## トラブルシューティング

### エラー: 「レースデータが見つかりませんでした」

→ 選択した競馬場・日付のデータが未登録です。先に通常のデータ登録を行ってください。

### エラー: 「払い戻しデータが空です」

→ 払い戻しデータ欄にテキストを貼り付けてから実行してください。

### 矛盾が多数検出される

→ 異なる日付のデータを貼り付けている可能性があります。競馬場と日付を確認してください。

## 技術仕様

### 更新されるデータ

- `race.payouts.tansho` - 単勝（馬番、払い戻し、人気）
- `race.payouts.fukusho` - 複勝（馬番、払い戻し、人気）
- `race.payouts.wakuren` - 枠連（組み合わせ、払い戻し、人気パターン、券人気）
- `race.payouts.umaren` - 馬連（組み合わせ、払い戻し、人気パターン、券人気）
- `race.payouts.wide` - ワイド（組み合わせ、払い戻し、人気パターン、券人気）
- `race.payouts.umatan` - 馬単（組み合わせ、払い戻し、人気パターン、券人気）
- `race.payouts.sanrenpuku` - 3連複（組み合わせ、払い戻し、人気パターン、券人気）
- `race.payouts.sanrentan` - 3連単（組み合わせ、払い戻し、人気パターン、券人気）

### 保持されるデータ

- レース番号
- レース名
- 条件（距離、馬場状態など）
- 着順結果（1-2-3着の馬番、馬名、人気）
- 頭立て数

## 実装詳細

### dataParser.js

- `updatePayoutDataOnly(payoutText, existingRaces)` - メイン処理
- `validatePayoutConsistency(tempRace, originalRace)` - 整合性チェック

### dataManager.js

- `getRacesByDate(racetrack, date)` - 既存データ取得
- `updateRacesByDate(racetrack, date, updatedRaces)` - データ更新

### app.js

- `updatePayoutDataOnly()` - UI処理とエラーハンドリング
